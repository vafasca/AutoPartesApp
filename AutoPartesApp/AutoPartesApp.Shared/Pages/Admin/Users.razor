@page "/admin/users"
@layout AdminLayout
@namespace AutoPartesApp.Shared.Pages.Admin

<!-- Top Navigation Bar - Responsive -->
<header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto">
        <!-- Title Row -->
        <div class="flex items-center p-4 justify-between">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-primary text-2xl lg:text-3xl">shield_person</span>
                <h1 class="text-lg lg:text-xl font-extrabold tracking-tight">Gestión de Usuarios</h1>
            </div>
            <div class="flex items-center gap-2">
                <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"
                        @onclick="ToggleSearch">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"
                        @onclick="ToggleFilters">
                    <span class="material-symbols-outlined">filter_list</span>
                </button>
            </div>
        </div>

        <!-- Search Bar (when toggled on mobile) -->
        @if (showSearch || !isMobileView)
        {
            <div class="px-4 pb-3">
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                    <input @bind="searchQuery"
                           @bind:event="oninput"
                           @onkeyup="HandleSearch"
                           class="w-full h-11 pl-10 pr-4 rounded-xl border-none bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary text-sm shadow-sm"
                           placeholder="Buscar por nombre o email..."
                           type="text" />
                </div>
            </div>
        }

        <!-- Segmented Control (Tabs) - Responsive -->
        <div class="px-4 pb-4">
            <div class="flex h-11 items-center justify-center rounded-xl bg-slate-200 dark:bg-slate-800/50 p-1">
                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-background-dark has-[:checked]:shadow-sm text-slate-500 dark:text-slate-400 has-[:checked]:text-primary font-bold text-sm transition-all">
                    <span class="truncate">Clientes</span>
                    <input checked="@(selectedTab == "clients")"
                           class="hidden"
                           name="user_type"
                           type="radio"
                           value="clients"
                           @onchange='() => ChangeTab("clients")' />
                </label>
                <label class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-lg px-2 has-[:checked]:bg-white dark:has-[:checked]:bg-background-dark has-[:checked]:shadow-sm text-slate-500 dark:text-slate-400 has-[:checked]:text-primary font-bold text-sm transition-all">
                    <span class="truncate">Repartidores</span>
                    <input checked="@(selectedTab == "drivers")"
                           class="hidden"
                           name="user_type"
                           type="radio"
                           value="drivers"
                           @onchange='() => ChangeTab("drivers")' />
                </label>
            </div>
        </div>
    </div>
</header>

<main class="pb-24 lg:pb-8">
    <div class="max-w-7xl mx-auto p-4">
        @if (isLoading)
        {
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center py-16">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Cargando usuarios...</p>
            </div>
        }
        else
        {
            <!-- Clients Section -->
            @if (selectedTab == "clients")
            {
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                            Usuarios Activos (@filteredClients.Count)
                        </h3>
                        <button class="text-primary text-xs font-bold hover:underline hidden lg:inline"
                                @onclick="ExportClients">
                            Exportar
                        </button>
                    </div>

                    @if (filteredClients.Count == 0)
                    {
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center py-16 text-center">
                            <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-full mb-4">
                                <span class="material-symbols-outlined text-slate-400 text-5xl">group</span>
                            </div>
                            <h3 class="text-slate-900 dark:text-white text-lg font-bold mb-2">No se encontraron clientes</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-sm max-w-sm">
                                No hay clientes que coincidan con la búsqueda
                            </p>
                        </div>
                    }
                    else
                    {
                        <!-- Desktop: Grid View -->
                        <div class="hidden lg:grid lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            @foreach (var client in filteredClients)
                            {
                                <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 rounded-xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg transition-shadow">
                                    <div class="p-4 flex gap-4">
                                        <div class="h-16 w-16 rounded-full bg-cover bg-center shrink-0 border-2 @GetUserBorderClass(client.Tier)"
                                             style='background-image: url("@client.AvatarUrl");'></div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <h4 class="font-bold text-base truncate">@client.Name</h4>
                                                <span class="@GetTierBadgeClass(client.Tier)">@client.Tier</span>
                                            </div>
                                            <p class="text-slate-500 dark:text-slate-400 text-sm">
                                                Frecuencia: <span class="@GetFrequencyColor(client.Frequency) font-semibold">@client.Frequency</span> | @client.OrderCount Pedidos
                                            </p>
                                            <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">
                                                Última compra: @client.LastPurchase
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex border-t border-slate-100 dark:border-slate-800 p-3 gap-3">
                                        <button class="flex-1 h-9 bg-primary text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-primary/90 transition-colors"
                                                @onclick="() => SendPromotion(client.Id)">
                                            <span class="material-symbols-outlined text-lg">campaign</span>
                                            <span class="hidden xl:inline">Enviar promoción</span>
                                            <span class="xl:hidden">Promoción</span>
                                        </button>
                                        <button class="px-4 h-9 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white rounded-lg text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                                                @onclick="() => BlockUser(client.Id, client.Name)">
                                            Bloquear
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Mobile: List View -->
                        <div class="lg:hidden space-y-3">
                            @foreach (var client in filteredClients)
                            {
                                <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 rounded-xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800 active:scale-[0.98] transition-transform">
                                    <div class="p-4 flex gap-3">
                                        <div class="h-14 w-14 rounded-full bg-cover bg-center shrink-0 border-2 @GetUserBorderClass(client.Tier)"
                                             style='background-image: url("@client.AvatarUrl");'></div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <h4 class="font-bold text-base truncate">@client.Name</h4>
                                                <span class="@GetTierBadgeClass(client.Tier)">@client.Tier</span>
                                            </div>
                                            <p class="text-slate-500 dark:text-slate-400 text-sm">
                                                <span class="@GetFrequencyColor(client.Frequency) font-semibold">@client.Frequency</span> • @client.OrderCount pedidos
                                            </p>
                                            <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">@client.LastPurchase</p>
                                        </div>
                                    </div>
                                    <div class="flex border-t border-slate-100 dark:border-slate-800 p-3 gap-2">
                                        <button class="flex-1 h-9 bg-primary text-white rounded-lg text-xs font-bold flex items-center justify-center gap-2"
                                                @onclick="() => SendPromotion(client.Id)">
                                            <span class="material-symbols-outlined text-base">campaign</span>
                                            Promoción
                                        </button>
                                        <button class="px-3 h-9 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white rounded-lg text-xs font-bold"
                                                @onclick="() => BlockUser(client.Id, client.Name)">
                                            Bloquear
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Drivers Section -->
            @if (selectedTab == "drivers")
            {
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-1">
                        <h3 class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
                            Repartidores en línea (@filteredDrivers.Count(d => d.IsOnline))
                        </h3>
                        <button class="text-primary text-xs font-bold hover:underline hidden lg:inline"
                                @onclick="ViewDriversMap">
                            Ver en Mapa
                        </button>
                    </div>

                    @if (filteredDrivers.Count == 0)
                    {
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center py-16 text-center">
                            <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-full mb-4">
                                <span class="material-symbols-outlined text-slate-400 text-5xl">local_shipping</span>
                            </div>
                            <h3 class="text-slate-900 dark:text-white text-lg font-bold mb-2">No se encontraron repartidores</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-sm max-w-sm">
                                No hay repartidores que coincidan con la búsqueda
                            </p>
                        </div>
                    }
                    else
                    {
                        <!-- Desktop: Grid View -->
                        <div class="hidden lg:grid lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            @foreach (var driver in filteredDrivers)
                            {
                                <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 rounded-xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800 hover:shadow-lg transition-shadow @(!driver.IsOnline ? "opacity-75" : "")">
                                    <div class="p-4 flex gap-4">
                                        <div class="relative h-16 w-16 shrink-0">
                                            <div class="h-16 w-16 rounded-full bg-cover bg-center border-2 border-slate-200 dark:border-slate-700"
                                                 style='background-image: url("@driver.AvatarUrl");'></div>
                                            <div class="@GetOnlineStatusClass(driver.IsOnline)"></div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <h4 class="font-bold text-base truncate">@driver.Name</h4>
                                                <span class="@GetDriverStatusBadgeClass(driver.IsOnline)">
                                                    @(driver.IsOnline ? "ACTIVO" : "DESCONECTADO")
                                                </span>
                                            </div>
                                            <p class="text-slate-500 dark:text-slate-400 text-sm flex items-center gap-1">
                                                <span class="material-symbols-outlined text-base">@driver.VehicleIcon</span>
                                                @driver.VehicleInfo
                                            </p>
                                            <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">
                                                @(driver.IsOnline ? $"En ruta: {driver.ActiveOrders} pedido(s)" : $"Última conexión: {driver.LastConnection}")
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex border-t border-slate-100 dark:border-slate-800 p-3 gap-3">
                                        <button class="flex-1 h-9 bg-primary text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90 transition-colors"
                                                disabled="@(!driver.IsOnline)"
                                                @onclick="() => AssignOrder(driver.Id)">
                                            <span class="material-symbols-outlined text-lg">assignment_add</span>
                                            <span class="hidden xl:inline">Asignar</span>
                                        </button>
                                        <button class="flex-1 h-9 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                                                @onclick="() => ViewDriverLocation(driver.Id)">
                                            <span class="material-symbols-outlined text-lg">distance</span>
                                            <span class="hidden xl:inline">Ver mapa</span>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Mobile: List View -->
                        <div class="lg:hidden space-y-3">
                            @foreach (var driver in filteredDrivers)
                            {
                                <div class="bg-gradient-to-br from-primary/10 to-primary/5 dark:from-primary/20 dark:to-primary/10 rounded-xl overflow-hidden shadow-sm border border-slate-100 dark:border-slate-800 active:scale-[0.98] transition-transform @(!driver.IsOnline ? "opacity-75" : "")">
                                    <div class="p-4 flex gap-3">
                                        <div class="relative h-14 w-14 shrink-0">
                                            <div class="h-14 w-14 rounded-full bg-cover bg-center border-2 border-slate-200 dark:border-slate-700"
                                                 style='background-image: url("@driver.AvatarUrl");'></div>
                                            <div class="@GetOnlineStatusClass(driver.IsOnline)"></div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <h4 class="font-bold text-base truncate">@driver.Name</h4>
                                                <span class="@GetDriverStatusBadgeClass(driver.IsOnline)">
                                                    @(driver.IsOnline ? "ACTIVO" : "OFF")
                                                </span>
                                            </div>
                                            <p class="text-slate-500 dark:text-slate-400 text-sm flex items-center gap-1">
                                                <span class="material-symbols-outlined text-base">@driver.VehicleIcon</span>
                                                @driver.VehicleInfo
                                            </p>
                                            <p class="text-slate-400 dark:text-slate-500 text-xs mt-1">
                                                @(driver.IsOnline ? $"{driver.ActiveOrders} pedido(s)" : driver.LastConnection)
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex border-t border-slate-100 dark:border-slate-800 p-3 gap-2">
                                        <button class="flex-1 h-9 bg-primary text-white rounded-lg text-xs font-bold flex items-center justify-center gap-1 disabled:opacity-50"
                                                disabled="@(!driver.IsOnline)"
                                                @onclick="() => AssignOrder(driver.Id)">
                                            <span class="material-symbols-outlined text-base">assignment_add</span>
                                            Asignar
                                        </button>
                                        <button class="flex-1 h-9 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white rounded-lg text-xs font-bold flex items-center justify-center gap-1"
                                                @onclick="() => ViewDriverLocation(driver.Id)">
                                            <span class="material-symbols-outlined text-base">distance</span>
                                            Mapa
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        }
    </div>
</main>