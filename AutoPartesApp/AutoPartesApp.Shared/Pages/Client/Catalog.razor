@page "/client/catalog"
@layout ClientLayout
@namespace AutoPartesApp.Shared.Pages.Client

<!-- Header Responsive -->
<header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
    <div class="flex items-center p-4 pb-2 justify-between max-w-7xl mx-auto">
        <button class="lg:hidden flex size-10 shrink-0 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700"
                @onclick="GoBack">
            <span class="material-symbols-outlined">arrow_back_ios_new</span>
        </button>

        <h1 class="text-slate-900 dark:text-white text-lg lg:text-2xl font-extrabold leading-tight tracking-tight flex-1 px-3 lg:px-0 text-center lg:text-left">
            Catálogo
        </h1>

        <div class="flex items-center gap-2">
            <button class="relative flex size-10 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700"
                    @onclick="ToggleNotifications">
                <span class="material-symbols-outlined">notifications</span>
                @if (hasNewNotifications)
                {
                    <span class="absolute top-2.5 right-2.5 flex h-2 w-2 items-center justify-center rounded-full bg-red-500"></span>
                }
            </button>
            <button class="relative flex size-10 items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700"
                    @onclick="GoToCart">
                <span class="material-symbols-outlined">shopping_cart</span>
                @if (cartItemsCount > 0)
                {
                    <span class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-white">@cartItemsCount</span>
                }
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="px-4 py-3 max-w-7xl mx-auto">
        <label class="flex flex-col min-w-40 h-12 w-full">
            <div class="flex w-full flex-1 items-stretch rounded-xl h-full shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="text-slate-400 flex border-none bg-white dark:bg-slate-800 items-center justify-center pl-4 rounded-l-xl">
                    <span class="material-symbols-outlined text-lg">search</span>
                </div>
                <input @bind="searchQuery"
                       @bind:event="oninput"
                       @onkeyup="HandleSearch"
                       class="form-input flex w-full min-w-0 flex-1 border-none bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-0 h-full placeholder:text-slate-400 px-4 rounded-r-xl text-base font-medium"
                       placeholder="Buscar repuestos, códigos..."
                       type="text" />
            </div>
        </label>
    </div>

    <!-- Filters - Responsive -->
    <div class="flex gap-3 px-4 pb-4 overflow-x-auto hide-scrollbar max-w-7xl mx-auto">
        <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full @(selectedCategory == "Todos" ? "bg-primary text-white shadow-md shadow-primary/20" : "bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700") px-4 transition-all"
                @onclick='() => FilterByCategory("Todos")'>
            <span class="text-sm font-semibold">Todos</span>
        </button>

        <!-- Filtro Marca -->
        <div class="relative">
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    @onclick="() => ToggleFilter(0)">
                <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">Marca</span>
                <span class="material-symbols-outlined text-sm">keyboard_arrow_down</span>
            </button>
            @if (showFilterDropdown[0])
            {
                <div class="absolute top-12 left-0 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 p-2 min-w-[150px] z-50">
                    @foreach (var brand in brands)
                    {
                        <button class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-sm"
                                @onclick='() => SelectBrand(brand)'>
                            @brand
                        </button>
                    }
                </div>
            }
        </div>

        <!-- Filtro Año -->
        <div class="relative">
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    @onclick="() => ToggleFilter(1)">
                <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">Año</span>
                <span class="material-symbols-outlined text-sm">keyboard_arrow_down</span>
            </button>
            @if (showFilterDropdown[1])
            {
                <div class="absolute top-12 left-0 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 p-2 min-w-[150px] z-50">
                    @foreach (var year in years)
                    {
                        <button class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-sm"
                                @onclick='() => SelectYear(year)'>
                            @year
                        </button>
                    }
                </div>
            }
        </div>

        <!-- Filtro Categoría -->
        <div class="relative">
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all"
                    @onclick="() => ToggleFilter(2)">
                <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">Categoría</span>
                <span class="material-symbols-outlined text-sm">keyboard_arrow_down</span>
            </button>
            @if (showFilterDropdown[2])
            {
                <div class="absolute top-12 left-0 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 p-2 min-w-[150px] z-50">
                    @foreach (var category in categories)
                    {
                        <button class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-sm"
                                @onclick='() => FilterByCategory(category)'>
                            @category
                        </button>
                    }
                </div>
            }
        </div>
    </div>
</header>

<main class="pb-32 lg:pb-8">
    <div class="max-w-7xl mx-auto">
        <!-- Results Info and Filters Toggle -->
        <div class="flex items-center justify-between px-4 py-4">
            <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">
                @filteredProducts.Count resultado@(filteredProducts.Count != 1 ? "s" : "") encontrado@(filteredProducts.Count != 1 ? "s" : "")
            </p>
            <button class="lg:hidden flex items-center gap-1 text-primary text-sm font-bold"
                    @onclick="ToggleFiltersModal">
                <span class="material-symbols-outlined text-base text-primary">tune</span>
                Filtros
            </button>
        </div>

        @if (isLoading)
        {
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center py-16 px-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Cargando productos...</p>
            </div>
        }
        else if (filteredProducts.Count == 0)
        {
            <!-- Empty State -->
            <div class="flex flex-col items-center justify-center py-16 px-4 text-center">
                <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-full mb-4">
                    <span class="material-symbols-outlined text-slate-400 text-5xl">search_off</span>
                </div>
                <h3 class="text-slate-900 dark:text-white text-lg font-bold mb-2">No se encontraron productos</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm max-w-sm mb-6">
                    @if (string.IsNullOrEmpty(searchQuery))
                    {
                        <text>No hay productos en esta categoría. Intenta con otros filtros.</text>
                    }
                    else
                    {
                        <text>No se encontraron productos con "@searchQuery". Intenta otra búsqueda.</text>
                    }
                </p>
                <button class="bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-primary/90 transition-colors"
                        @onclick="ClearFilters">
                    Limpiar Filtros
                </button>
            </div>
        }
        else
        {
            <!-- Products Grid - Responsive -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 px-4">
                @foreach (var product in filteredProducts)
                {
                    <div class="flex flex-col bg-white dark:bg-slate-800/50 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800 shadow-sm hover:shadow-lg hover:border-primary/30 transition-all group">
                        <!-- Product Image -->
                        <div class="relative w-full aspect-square bg-slate-100 dark:bg-slate-800">
                            <div class="absolute inset-0 bg-center bg-no-repeat bg-cover group-hover:scale-105 transition-transform duration-300"
                                 style='background-image: url("@product.ImageUrl");'></div>

                            <!-- Stock Badge -->
                            <div class="absolute top-2 left-2">
                                <span class="px-2 py-1 rounded @GetStockBadgeClass(product.StockStatus) text-white text-[10px] font-bold uppercase">
                                    @product.StockStatus
                                </span>
                            </div>

                            <!-- Favorite Button (Desktop) -->
                            <button class="hidden lg:flex absolute top-2 right-2 size-8 items-center justify-center rounded-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity"
                                    @onclick='() => ToggleFavorite(product.Id)'
                                    @onclick:stopPropagation>
                                <span class="material-symbols-outlined text-slate-600 dark:text-slate-300 text-lg">
                                    @(product.IsFavorite ? "favorite" : "favorite_border")
                                </span>
                            </button>
                        </div>

                        <!-- Product Info -->
                        <div class="p-3 flex flex-col flex-1">
                            <p class="text-slate-900 dark:text-white text-sm font-bold leading-tight line-clamp-2 mb-1 group-hover:text-primary transition-colors">
                                @product.Name
                            </p>
                            <p class="text-slate-500 dark:text-slate-400 text-xs font-medium mb-3">
                                @product.Compatibility
                            </p>

                            <!-- Price and Action -->
                            <div class="mt-auto">
                                @if (product.OriginalPrice.HasValue)
                                {
                                    <div class="flex items-baseline gap-2 mb-3">
                                        <p class="text-slate-400 text-xs line-through">@product.OriginalPrice.Value.ToString("C")</p>
                                        <p class="text-primary text-lg font-extrabold">@product.Price.ToString("C")</p>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-primary text-lg font-extrabold mb-3">@product.Price.ToString("C")</p>
                                }

                                <button class="w-full h-9 flex items-center justify-center gap-2 rounded-lg bg-primary text-white text-xs font-bold transition-all hover:bg-primary/90 active:scale-95 shadow-lg shadow-primary/30 disabled:opacity-50 disabled:cursor-not-allowed"
                                        @onclick='() => AddToCart(product.Id)'
                                        disabled="@(product.StockStatus == "Agotado")">
                                    <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                                    <span>@(product.StockStatus == "Agotado" ? "Agotado" : "Añadir")</span>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</main>